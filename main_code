#include<stdio.h>       //for all inputs/outputs
#include<conio.h>       //for getch()
#include<stdlib.h>      //for exit function
#include<string.h>      //for crucial operations

struct DATE             //a structure to hold date
{
    int d,m,y;
};

struct cricket          //main structure to hold all the data
{
    char name_comp[30],name_venue[30],team1[30],team2[30],toss[30],results[10];
    int overs;
    struct DATE date;
    int runs[24];
}c;

void menu();                //declaring all function prototypes
void new_sheet();
void view_all();
void view_sheet();
void del_sheet();

void line()                     //function to display a simple line
{
    int i=0;
    printf("\n");
    for(i=0;i<40;i++)
        printf("===");
    printf("\n");
}

void new_sheet()                    //function to add a new score sheet
{
    view_all();                 //function call to view all existing score sheets
    int test=0; int t=0; char ch,th;
    char extn[]=".dat";
    char file[30]="",temp[30]="";
    printf("\nEnter name of the score sheet to store in file, without extension. ");
    printf("\nFor example, \"scores1\". Please enter file name: ");
    scanf("%s",temp);
    strcpy(file,strcat(temp,extn));
    strcpy(temp,"");
    FILE *fp;
    fp=fopen("filenames.txt","r");
    while(fscanf(fp,"%s",temp)!=EOF)   //scanning a file that holds the names of the sheets to see if it already exists
    {
        if(strcmp(file,temp)==0)
        {
            test=1;
        }
    }
    fclose(fp);
    if(test==1)
    {
        printf("\nFile name already exists.");
    }
    else        //taking input for all data
    {
        system("cls");
        fp=fopen("filenames.txt","a");
        fprintf(fp,"%s",file); fprintf(fp,"\n");
        fclose(fp);
        fp=fopen(file,"w");
        printf("\nEnter The Name of the Competition: "); scanf("%c\n",&th); fgets(c.name_comp,30,stdin);  c.name_comp[strcspn(c.name_comp, "\n")] = 0;
        fprintf(fp," %s\n",c.name_comp); fprintf(fp,"\n");
        printf("\nEnter The Name of the Venue: ");  fgets(c.name_venue,30,stdin);  c.name_venue[strcspn(c.name_venue, "\n")] = 0;
        fprintf(fp," %s\n",c.name_venue); fprintf(fp,"\n");
        printf("\nEnter Team 1 Name: ");  fgets(c.team1,30,stdin);  c.team1[strcspn(c.team1, "\n")] = 0;
        fprintf(fp," %s\n",c.team1); fprintf(fp,"\n");
        printf("\nEnter Team 2 Name: ");  fgets(c.team2,30,stdin);  c.team2[strcspn(c.team2, "\n")] = 0;
        fprintf(fp," %s\n",c.team2); fprintf(fp,"\n");
        do
        {
            printf("\nWhich Team won the toss, %s or %s?(1/2): ",c.team1,c.team2); scanf(" %c",&ch);
            if(ch=='1')
            {
                strcpy(c.toss,c.team1); break;
            }
            else if(ch=='2')
            {
                strcpy(c.toss,c.team2); break;
            }
            else
                printf("\nInvalid Option.");
        }while(t);
        fprintf(fp,"%s",c.toss); fprintf(fp,"\n");
        do
        {
            printf("\nWhat did %s pick, Batting(1) or Bowling(2)?(1/2): ",c.toss); scanf(" %c",&ch);
            if(ch=='1')
            {
                strcpy(c.results,"Batting"); break;
            }
            else if(ch=='2')
            {
                strcpy(c.results,"Bowling"); break;
            }
            else
                printf("\nInvalid Option.");
        }while(t);
        fprintf(fp,"%s",c.results); fprintf(fp,"\n");
        printf("\nEnter The Number of Overs Covered: "); scanf("%d",&c.overs);
        fprintf(fp,"%d",c.overs); fprintf(fp,"\n");
        printf("\nEnter The Date of the Match(dd/mm/yyyy): "); scanf("%d/%d/%d", &c.date.d, &c.date.m, &c.date.y);
        fprintf(fp,"%d/%d/%d", c.date.d, c.date.m, c.date.y); fprintf(fp,"\n");
        c.runs[22]=0; c.runs[23]=0;
        printf("\nEnter the runs of each batsman in %s: ",c.team1);
        for(t=0;t<11;t++)
        {
            printf("\nBatsman %d: ",t+1); scanf("%d",&c.runs[t]); fprintf(fp,"%d",c.runs[t]); fprintf(fp,"\n");
            c.runs[22]+=c.runs[t];
        }
        printf("\nEnter the runs of each batsman in %s: ",c.team2);
        for(t=11;t<22;t++)
        {
            printf("\nBatsman %d: ",t-10); scanf("%d",&c.runs[t]); fprintf(fp,"%d",c.runs[t]); fprintf(fp,"\n");
            c.runs[23]+=c.runs[t];
        }
        fprintf(fp,"%d",c.runs[22]); fprintf(fp,"\n");
        fprintf(fp,"%d",c.runs[23]); fprintf(fp,"\n");
        fclose(fp);
    }
    getch();
}

void view_sheet()       //function to view details of a score sheet
{
    view_all();
    int test=0;
    char file[30]="",temp[30]="",extn[]=".dat";
    printf("\nEnter the name of the score sheet without extension to view: ");
    scanf("%s",file);
    strcat(file,extn);
    FILE *fp;
    fp=fopen("filenames.txt","r");
    while(fscanf(fp,"%s",temp)!=EOF)        //checking if the given sheet exists
    {
        if(strcmp(file,temp)==0)
        {
            test=1;
        }
    }
    fclose(fp);
    if(test==1)         //displaying all the data in a neat format
    {
        system("cls");
        int i=0;
        fp=fopen(file,"r");
        fscanf(fp," %[^\n] %[^\n] %[^\n] %[^\n] %[^\n] %[^\n] %d %d/%d/%d", c.name_comp, c.name_venue, c.team1, c.team2, c.toss, c.results, &c.overs, &c.date.d, &c.date.m, &c.date.y);
        line();
        printf("\nCompetition Name: %s",c.name_comp);
        printf("\nVenue: %s\t\tDate: %d/%d/%d",c.name_venue,c.date.d, c.date.m, c.date.y);
        printf("\nMatch: %s Vs. %s",c.team1,c.team2);
        printf("\n%s won the toss, and chose %s.",c.toss,c.results);
        printf("\nThe Match lasted for %d overs.",c.overs);
        line();
        for(i=0;i<24;i++)
        {
            fscanf(fp,"%d",&c.runs[i]);
        }
        printf("\n||%-40s||%s",c.team1,c.team2);
        c.runs[22]=0; c.runs[23]=0;
        for(i=0;i<11;i++)
        {
            if(i>=9)
                printf("\n||Batsman %d: %-28d||Batsmen %d: %d",i+1,c.runs[i],i+1,c.runs[i+11]);
            else
                printf("\n||Batsman %d:  %-28d||Batsmen %d:  %d",i+1,c.runs[i],i+1,c.runs[i+11]);
            c.runs[22]+=c.runs[i]; c.runs[23]+=c.runs[i+11];
        }
        line();
        printf("\n%s scored %d runs and %s scored %d runs.",c.team1,c.runs[22],c.team2,c.runs[23]);
        if(c.runs[22]>c.runs[23])
        {
            printf("\n%s wins by %d runs.",c.team1,(c.runs[22]-c.runs[23]));
        }
        else if(c.runs[22]<c.runs[23])
        {
            printf("\n%s wins by %d runs.",c.team2,(c.runs[23]-c.runs[22]));
        }
        else
            printf("\nIt was a draw.");
        fclose(fp);
    }
    else
    {
        printf("\nNo such score sheet exists.");
    }
    getch();
}

void del_sheet()            //function to delete a score sheet
{
    system("cls");
    view_all();
    char ch[20]="",file[20]="",extn[]=".dat"; int x=0;
    printf("\nEnter the name of the score sheet without the extension: ");
    scanf("%s",ch);
    strcat(ch,extn);
    FILE *fp,*fp2;
    fp=fopen("filenames.txt","r");
    while(fscanf(fp,"%s",file)!=EOF)        //checks if the sheet exists
    {
        if(strcmp(file,ch)==0)          //if existing, the file of the sheet is removed
        {
            remove(ch);
            printf("\nDeleted Successfully.");
            x=1;        //flag value
        }
        else        //all file names except the one to be deleted is stored in a new file
        {
            fp2=fopen("temp.txt","a");
            fprintf(fp2,"%s",file); fprintf(fp2,"\n");
            fclose(fp2);
        }
    }
    if(x==0)
    {
        printf("\nNo such file was found to be deleted.");
    }
    fclose(fp);
    remove("filenames.txt");
    rename("temp.txt","filenames.txt");
    getch();
}

void view_all()     //function to view the names of existing score sheets
{
    system("cls");
    line();
    printf("\nCurrent Files: ");
    char file[30]=""; int i=1;
    FILE *fp;
    fp=fopen("filenames.txt","r");
    while(fscanf(fp,"%s",file)!=EOF)        //reading the file containing the score sheet names
    {
        printf("\n\t%d. %s",i,file);
        i++;
    }
    fclose(fp);
    line();
}

void menu()         //menu function in a do-while loop
{
    char choice;
    do
    {
        system("cls");
        printf("\nCricket Score Sheet");
        printf("\n1. Create New Sheet");
        printf("\n2. View Existing Sheet");
        printf("\n3. View Filenames storing Score Sheets");
        printf("\n4. Delete a Score Sheet");
        printf("\n5. Exit");
        printf("\nEnter Your Choice(1/2/3/4/5): ");
        scanf(" %c",&choice);
        switch(choice)
        {
            case '1': new_sheet(); menu(); break;
            case '2': view_sheet(); menu(); break;
            case '3': view_all(); getch(); menu(); break;
            case '4': del_sheet(); menu(); break;
            case '5': printf("\n\nThank You for using this application.\n\n"); exit(0); break;
            default: printf("\nInvalid Choice."); getch();
        }
    }while(choice);
}

int main()          //main function
{
    system("color 2");      //new color for text
    menu();     //function call
    return 0;
}
